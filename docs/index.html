<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Erik Bernhardson (Engineering)" />
<meta name="author" content="David Causse (Engineering &amp; Report)" />
<meta name="author" content="Trey Jones (Engineering &amp; Review)" />
<meta name="author" content="Mikhail Popov (Review)" />
<meta name="author" content="Deb Tankersley (Product Management)" />
<meta name="author" content="Chelsy Xie (Analysis &amp; Report)" />

<meta name="date" content="2017-01-05" />

<title>Second BM25 A/B Test Analysis</title>

<script src="index_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="index_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="index_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="index_files/tocify-1.9.1/jquery.tocify.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; } /* Keyword */
code > span.dt { color: #dfdfbf; } /* DataType */
code > span.dv { color: #dcdccc; } /* DecVal */
code > span.bn { color: #dca3a3; } /* BaseN */
code > span.fl { color: #c0bed1; } /* Float */
code > span.ch { color: #dca3a3; } /* Char */
code > span.st { color: #cc9393; } /* String */
code > span.co { color: #7f9f7f; } /* Comment */
code > span.ot { color: #efef8f; } /* Other */
code > span.al { color: #ffcfaf; } /* Alert */
code > span.fu { color: #efef8f; } /* Function */
code > span.er { color: #c3bf9f; } /* Error */
code > span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
code > span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code > span.sc { color: #dca3a3; } /* SpecialChar */
code > span.vs { color: #cc9393; } /* VerbatimString */
code > span.ss { color: #cc9393; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #f0dfaf; } /* ControlFlow */
code > span.op { color: #f0efd0; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code > span.at { } /* Attribute */
code > span.do { color: #7f9f7f; } /* Documentation */
code > span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code > span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code > span.in { color: #7f9f7f; font-weight: bold; } /* Information */
div.sourceCode {
  overflow-x: visible;
}
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script src="index_files/navigation-1.1/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: -22px; }
.code-folding-btn.collapsed { margin-bottom: 4px; }
</style>
<script src="index_files/navigation-1.1/codefolding.js"></script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.9em;
  padding-left: 5px;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
  padding-left: 10px;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Second BM25 A/B Test Analysis</h1>
<h4 class="author"><em><a href = 'https://meta.wikimedia.org/wiki/User:EBernhardson_(WMF)'>Erik Bernhardson</a> (Engineering)</em></h4>
<h4 class="author"><em><a href = 'https://www.mediawiki.org/wiki/User:DCausse_(WMF)'>David Causse</a> (Engineering &amp; Report)</em></h4>
<h4 class="author"><em><a href = 'https://meta.wikimedia.org/wiki/User:TJones_(WMF)'>Trey Jones</a> (Engineering &amp; Review)</em></h4>
<h4 class="author"><em><a href = 'https://meta.wikimedia.org/wiki/User:MPopov_(WMF)'>Mikhail Popov</a> (Review)</em></h4>
<h4 class="author"><em><a href = 'https://meta.wikimedia.org/wiki/User:DTankersley_(WMF)'>Deb Tankersley</a> (Product Management)</em></h4>
<h4 class="author"><em><a href = 'https://meta.wikimedia.org/wiki/User:CXie_(WMF)'>Chelsy Xie</a> (Analysis &amp; Report)</em></h4>
<h4 class="date"><em>05 January 2017</em></h4>

</div>


<script language="JavaScript">
$(function() {
  /* Lets the user click on the images to view them in full resolution. */
  $("div.figure img").wrap(function() {
    var link = $('<a/>');
    link.attr('href', $(this).attr('src'));
    link.attr('title', $(this).attr('alt'));
    link.attr('target', '_blank');
    return link;
  });
});
</script>
<p>
{ <a href="https://github.com/wikimedia-research/Discovery-Search-2ndTest-BM25_jazhth/blob/master/docs/index.Rmd">RMarkdown Source</a> | <a href="https://github.com/wikimedia-research/Discovery-Search-2ndTest-BM25_jazhth">Analysis Codebase</a> }
</p>
<div id="executive-summary" class="section level2">
<h2>Executive Summary</h2>
<p>In order to assess the efficacy of BM25 in space-less language, Discovery’s Search team has decided to conduct a second A/B test in Chinese, Japanese and Thai Wikipedias. We observed that the test group that used per-field query builder with incoming links and pageviews as query-independent factors had a much better Zero Result Rate but slightly worse PaulScores, large decrease in clickthrough rate, and fewer users clicked on the first result first, which indicates that we are showing test group users worse results. However, longer dwell-time and fewer query reformulations show that test group users might actually like the results they are getting better than the control group in that respect. We recommend deploying BM25 for all wikis but not reindexing projects in space-less languages for now.</p>
</div>
<div id="background" class="section level2">
<h2>Background</h2>
<p>To improve the relevancy of search results, Discovery’s Search team decided to try a new document-ranking function called <a href="https://en.wikipedia.org/wiki/Okapi_BM25">Okapi BM25</a> (BM stands for Best Matching), and ran an <a href="https://phabricator.wikimedia.org/T143585">A/B test</a> from August 30 to September 10 to assess the efficacy of the proposed switch. The <a href="https://wikimedia-research.github.io/Discovery-Search-Test-BM25">analysis</a> showed that BM25 ranking with incoming links and pageviews as query-independent factors appears to give users results that are more relevant and that they engage with more.</p>
<p>However, we then <a href="https://phabricator.wikimedia.org/T147008#2679631">realized</a> that our analysis chain is sub-optimal for space-less language queries, which will break words on every characters for the plain field. Therefore, we ran a <a href="https://phabricator.wikimedia.org/T147495">second A/B test</a> for Chinese, Japanese and Thai Wikipedias to test whether the new per-field BM25 builder is sufficiently worse with those languages. We are primarily interested in:</p>
<ul>
<li><strong>Zero results rate</strong>, the proportion of searches that yielded zero results (smaller is usually better)</li>
<li><strong>Users’ engagement</strong> with the search results, measured as the clickthrough rate (bigger is better)</li>
<li><strong>PaulScore</strong>, a metric of search results’ relevancy that relies on the position of the clicked result[s] (bigger is better); see <a href="https://wikimedia-research.github.io/Discovery-Search-Test-BM25/#paulscore_definition">PaulScore Definition</a> for more details</li>
<li><strong>Query reformulation</strong> – one way to think about the strength of our search engine is how many times the user reformulates their query; if a user in the test group has to reformulate their query many more times to get the results they are interested in, then maybe the change is for the worse</li>
<li><strong>Dwell Time</strong>, the time (seconds) that users stayed on the pages they visited by clicking on the search results (bigger is better)</li>
<li><strong>Scroll</strong> – if users scroll on the visited page, they are more likely to engage with the contents</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Install packages used in the report:</span>
<span class="kw">install.packages</span>(<span class="kw">c</span>(<span class="st">&quot;devtools&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;binom&quot;</span>))
devtools::<span class="kw">install_github</span>(<span class="st">&quot;hadley/ggplot2&quot;</span>)
<span class="co"># ^ development version of ggplot2 includes subtitles</span>
devtools::<span class="kw">install_github</span>(<span class="st">&quot;wikimedia/wikimedia-discovery-polloi&quot;</span>)
<span class="co"># ^ for converting 100000 into 100K via polloi::compress()</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load packages that we will be using in this report:</span>
<span class="kw">library</span>(tidyverse) <span class="co"># for ggplot2, dplyr, tidyr, broom, etc.</span>
<span class="kw">library</span>(binom) <span class="co"># for Bayesian confidence intervals of proportions</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># PaulScore Calculation</span>
query_score &lt;-<span class="st"> </span>function(positions, F) {
   if (<span class="kw">length</span>(positions) ==<span class="st"> </span><span class="dv">1</span> ||<span class="st"> </span><span class="kw">all</span>(<span class="kw">is.na</span>(positions))) {
    <span class="co"># no clicks were made</span>
    <span class="kw">return</span>(<span class="dv">0</span>)
   } else {
     positions &lt;-<span class="st"> </span>positions[!<span class="kw">is.na</span>(positions)] <span class="co"># when operating on &#39;events&#39; dataset, searchResultPage events won&#39;t have positions</span>
  <span class="kw">return</span>(<span class="kw">sum</span>(F^positions))
   }
}
<span class="co"># Bootstrapping</span>
bootstrap_mean &lt;-<span class="st"> </span>function(x, m, <span class="dt">seed =</span> <span class="ot">NULL</span>) {
  if (!<span class="kw">is.null</span>(seed)) {
    <span class="kw">set.seed</span>(seed)
  }
  n &lt;-<span class="st"> </span><span class="kw">length</span>(x)
  <span class="kw">return</span>(<span class="kw">replicate</span>(m, <span class="kw">mean</span>(x[<span class="kw">sample.int</span>(n, n, <span class="dt">replace =</span> <span class="ot">TRUE</span>)])))
}</code></pre></div>
</div>
<div id="data" class="section level2">
<h2>Data</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Import events fetched from MySQL</span>
<span class="kw">load</span>(<span class="kw">path</span>(<span class="st">&quot;data/ab-test_bm25.RData&quot;</span>))
events &lt;-<span class="st"> </span>events[!<span class="kw">duplicated</span>(events$event_id),]
events &lt;-<span class="st"> </span>events %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(date, wiki, test_group, session_id, search_id) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(<span class="st">&quot;searchResultPage&quot;</span> %in%<span class="st"> </span>action) %&gt;%
<span class="st">  </span>ungroup %&gt;%<span class="st"> </span><span class="kw">as.data.frame</span>() <span class="co"># remove search_id without SERP asscociated</span>
events$test_group &lt;-<span class="st"> </span><span class="kw">factor</span>(
  events$test_group,
  <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;bm25:control&quot;</span>, <span class="st">&quot;bm25:inclinks_pv&quot;</span>),
  <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Control Group (tf–idf)&quot;</span>, <span class="st">&quot;Using per-field query builder with incoming links and pageviews as QIFs&quot;</span>))
cirrus &lt;-<span class="st"> </span>readr::<span class="kw">read_tsv</span>(<span class="kw">path</span>(<span class="st">&quot;data/ab-test_bm25_cirrus-results.tsv.gz&quot;</span>), <span class="dt">col_types =</span> <span class="st">&quot;cccc&quot;</span>)
cirrus &lt;-<span class="st"> </span>cirrus[!<span class="kw">duplicated</span>(cirrus),]
events &lt;-<span class="st"> </span><span class="kw">left_join</span>(events, cirrus, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;event_id&quot;</span>, <span class="st">&quot;page_id&quot;</span>, <span class="st">&quot;cirrus_id&quot;</span>))
<span class="kw">rm</span>(cirrus)</code></pre></div>
<p>For Chinese Wikipedia (zhwiki) and Japanese Wikipedia (jawiki), users had a 1 in 16 chance of being selected for anonymous tracking according to our <a href="https://meta.wikimedia.org/w/index.php?title=Schema:TestSearchSatisfaction2&amp;id=15922352">TestSearchSatisfaction2 #15922352</a> event logging schema. Those users who were randomly selected to have their sessions anonymously tracked then had a 12 in 13 chance of being selected for the BM25 test. For Thai Wikipedia (thwiki), users had a 1 in 5 chance of being selected for search satisfaction tracking and then had a 38 in 39 chance of being selected for the BM25 test due to fewer visitors to that particular project. The sampled sessions were evenly put into a control group (tf-idf) and a test group (using per-field query builder with incoming links and pageviews as QIFs); see the <a href="https://wikimedia-research.github.io/Discovery-Search-Test-BM25/#data">first BM25 test report</a> for more details. The test was deployed on October 27th and ran for a week for zhwiki and jawiki, but until November 15th for thwiki specifically.</p>
<p>The full-text (as opposed to auto-complete) searching event logging data was extracted from the database using this <a href="https://github.com/wikimedia-research/Discovery-Search-2ndTest-BM25_jazhth/blob/master/data.R">script</a>. We collected a total of 230.2K events from 36.1K unique sessions. See Table 1 for counts broken down by wiki and test group.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">events_summary &lt;-<span class="st"> </span>events %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> </span>test_group) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(search_id)), <span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">n</span>()) %&gt;%<span class="st"> </span>ungroup %&gt;%
<span class="st">  </span>{
    <span class="kw">rbind</span>(., <span class="kw">tibble</span>(
      <span class="st">`</span><span class="dt">wiki</span><span class="st">`</span> =<span class="st"> &quot;All Wikis&quot;</span>,
      <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> &quot;Total&quot;</span>,
      <span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(.$<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span>),
      <span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(.$<span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span>)
    ))
  } %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">prettyNum</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span>, <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>),
         <span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">prettyNum</span>(<span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span>, <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>))
knitr::<span class="kw">kable</span>(events_summary, <span class="dt">format =</span> <span class="st">&quot;markdown&quot;</span>, <span class="dt">align =</span> <span class="kw">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;r&quot;</span>, <span class="st">&quot;r&quot;</span>))</code></pre></div>
<table>
<colgroup>
<col width="9%" />
<col width="61%" />
<col width="14%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">wiki</th>
<th align="left">Test group</th>
<th align="right">Search sessions</th>
<th align="right">Events recorded</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">jawiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">7,579</td>
<td align="right">54,261</td>
</tr>
<tr class="even">
<td align="left">jawiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">7,610</td>
<td align="right">59,808</td>
</tr>
<tr class="odd">
<td align="left">thwiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">3,889</td>
<td align="right">18,954</td>
</tr>
<tr class="even">
<td align="left">thwiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">4,055</td>
<td align="right">21,217</td>
</tr>
<tr class="odd">
<td align="left">zhwiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">6,510</td>
<td align="right">37,561</td>
</tr>
<tr class="even">
<td align="left">zhwiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">6,478</td>
<td align="right">38,382</td>
</tr>
<tr class="odd">
<td align="left">All Wikis</td>
<td align="left">Total</td>
<td align="right">36,121</td>
<td align="right">230,183</td>
</tr>
</tbody>
</table>
<p class="caption">
<strong>Table 1</strong>: Counts of sessions anonymously tracked and events collected during the second A/B test (Oct 27 - Nov 15).
</p>
<p>An issue we noticed with the event logging is that when the user goes to the next page of search results or clicks the Back button after visiting a search result, a new page ID is generated for the search results page. The page ID is how we connect click events to search result page events. There is currently a Phabricator ticket (<a href="https://phabricator.wikimedia.org/T146337">T146337</a>) for addressing these issues. For this analysis, we de-duplicated by connecting search engine results page (searchResultPage) events that have the exact same search query, and then connected click events together based on the searchResultPage connectivity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">temp &lt;-<span class="st"> </span>events %&gt;%
<span class="st">  </span><span class="kw">filter</span>(action ==<span class="st"> &quot;searchResultPage&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(session_id, search_id, query) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new_page_id =</span> <span class="kw">min</span>(page_id)) %&gt;%
<span class="st">  </span>ungroup %&gt;%
<span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(page_id, new_page_id)) %&gt;%
<span class="st">  </span>distinct
events &lt;-<span class="st"> </span><span class="kw">left_join</span>(events, temp, <span class="dt">by =</span> <span class="st">&quot;page_id&quot;</span>); <span class="kw">rm</span>(temp)
events$new_page_id[<span class="kw">is.na</span>(events$new_page_id)] &lt;-<span class="st"> </span>events$page_id[<span class="kw">is.na</span>(events$new_page_id)] 
temp &lt;-<span class="st"> </span>events %&gt;%
<span class="st">  </span><span class="kw">filter</span>(action ==<span class="st"> &quot;searchResultPage&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(new_page_id, ts) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dupe =</span> <span class="kw">duplicated</span>(new_page_id, <span class="dt">fromLast =</span> <span class="ot">FALSE</span>)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(event_id, dupe))
events &lt;-<span class="st"> </span><span class="kw">left_join</span>(events, temp, <span class="dt">by =</span> <span class="st">&quot;event_id&quot;</span>); <span class="kw">rm</span>(temp)
events$dupe[events$action !=<span class="st"> &quot;searchResultPage&quot;</span>] &lt;-<span class="st"> </span><span class="ot">FALSE</span>
events &lt;-<span class="st"> </span>events[!events$dupe &amp;<span class="st"> </span>!<span class="kw">is.na</span>(events$new_page_id), ] %&gt;%
<span class="st">  </span><span class="kw">select</span>(-<span class="kw">c</span>(page_id, dupe)) %&gt;%
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">page_id =</span> new_page_id) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(date, session_id, search_id, page_id, <span class="kw">desc</span>(action), ts)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Summarize on a page-by-page basis for each SERP:</span>
searches &lt;-<span class="st"> </span>events %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span> =<span class="st"> </span>test_group, session_id, search_id, page_id) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(<span class="st">&quot;searchResultPage&quot;</span> %in%<span class="st"> </span>action) %&gt;%<span class="st"> </span><span class="co"># filter out searches where we have clicks but not searchResultPage events</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">ts =</span> ts[<span class="dv">1</span>], <span class="dt">query =</span> query[<span class="dv">1</span>],
            <span class="dt">results =</span> <span class="kw">ifelse</span>(n_results_returned[<span class="dv">1</span>] &gt;<span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;some&quot;</span>, <span class="st">&quot;zero&quot;</span>),
            <span class="dt">clickthrough =</span> <span class="st">&quot;click&quot;</span> %in%<span class="st"> </span>action,
            <span class="st">`</span><span class="dt">no. results clicked</span><span class="st">`</span> =<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(position_clicked))-<span class="dv">1</span>,
            <span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span> =<span class="st"> </span><span class="kw">ifelse</span>(clickthrough, position_clicked[<span class="dv">2</span>], <span class="ot">NA</span>),
            <span class="st">`</span><span class="dt">result page IDs</span><span class="st">`</span> =<span class="st"> </span><span class="kw">paste</span>(<span class="kw">unique</span>(result_pids[!<span class="kw">is.na</span>(result_pids)]), <span class="dt">collapse=</span><span class="st">&#39;,&#39;</span>),
            <span class="st">`</span><span class="dt">Query score (F=0.1)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">query_score</span>(position_clicked, <span class="fl">0.1</span>),
            <span class="st">`</span><span class="dt">Query score (F=0.5)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">query_score</span>(position_clicked, <span class="fl">0.5</span>),
            <span class="st">`</span><span class="dt">Query score (F=0.9)</span><span class="st">`</span> =<span class="st"> </span><span class="kw">query_score</span>(position_clicked, <span class="fl">0.9</span>)) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(ts)
searches$<span class="st">`</span><span class="dt">result page IDs</span><span class="st">`</span>[searches$<span class="st">`</span><span class="dt">result page IDs</span><span class="st">`</span>==<span class="st">&quot;&quot;</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></code></pre></div>
<p>After de-duplicating, we collapsed 213.4K (searchResultPage and click) events into 64.5K searches. See Table 2 for counts broken down by wiki and test group.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">events_summary2 &lt;-<span class="st"> </span>events %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> </span>test_group) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(search_id)), <span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">n</span>()) %&gt;%<span class="st"> </span>ungroup %&gt;%
<span class="st">  </span>{
    <span class="kw">rbind</span>(., <span class="kw">tibble</span>(
      <span class="st">`</span><span class="dt">wiki</span><span class="st">`</span> =<span class="st"> &quot;All Wikis&quot;</span>,
      <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> &quot;Total&quot;</span>,
      <span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(.$<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span>),
      <span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(.$<span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span>)
    ))
  } %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">prettyNum</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span>, <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>),
         <span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">prettyNum</span>(<span class="st">`</span><span class="dt">Events recorded</span><span class="st">`</span>, <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>))
searches_summary &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> `</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(search_id)), <span class="st">`</span><span class="dt">Searches recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">n</span>()) %&gt;%<span class="st"> </span>ungroup %&gt;%
<span class="st">  </span>{
    <span class="kw">rbind</span>(., <span class="kw">tibble</span>(
      <span class="st">`</span><span class="dt">wiki</span><span class="st">`</span> =<span class="st"> &quot;All Wikis&quot;</span>,
      <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> &quot;Total&quot;</span>,
      <span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(.$<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span>),
      <span class="st">`</span><span class="dt">Searches recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(.$<span class="st">`</span><span class="dt">Searches recorded</span><span class="st">`</span>)
    ))
  } %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span> =<span class="st"> </span><span class="kw">prettyNum</span>(<span class="st">`</span><span class="dt">Search sessions</span><span class="st">`</span>, <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>),
         <span class="st">`</span><span class="dt">Searches recorded</span><span class="st">`</span> =<span class="st"> </span><span class="kw">prettyNum</span>(<span class="st">`</span><span class="dt">Searches recorded</span><span class="st">`</span>, <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>))
knitr::<span class="kw">kable</span>(<span class="kw">inner_join</span>(searches_summary, events_summary2, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;wiki&quot;</span>, <span class="st">&quot;Test group&quot;</span>, <span class="st">&quot;Search sessions&quot;</span>)), 
             <span class="dt">format =</span> <span class="st">&quot;markdown&quot;</span>, <span class="dt">align =</span> <span class="kw">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;r&quot;</span>, <span class="st">&quot;r&quot;</span>, <span class="st">&quot;r&quot;</span>))</code></pre></div>
<table>
<colgroup>
<col width="8%" />
<col width="53%" />
<col width="12%" />
<col width="13%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">wiki</th>
<th align="left">Test group</th>
<th align="right">Search sessions</th>
<th align="right">Searches recorded</th>
<th align="right">Events recorded</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">jawiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">7,579</td>
<td align="right">13,839</td>
<td align="right">50,845</td>
</tr>
<tr class="even">
<td align="left">jawiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">7,610</td>
<td align="right">13,982</td>
<td align="right">56,097</td>
</tr>
<tr class="odd">
<td align="left">thwiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">3,889</td>
<td align="right">7,005</td>
<td align="right">16,379</td>
</tr>
<tr class="even">
<td align="left">thwiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">4,055</td>
<td align="right">7,086</td>
<td align="right">18,481</td>
</tr>
<tr class="odd">
<td align="left">zhwiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">6,510</td>
<td align="right">11,450</td>
<td align="right">35,262</td>
</tr>
<tr class="even">
<td align="left">zhwiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">6,478</td>
<td align="right">11,173</td>
<td align="right">36,373</td>
</tr>
<tr class="odd">
<td align="left">All Wikis</td>
<td align="left">Total</td>
<td align="right">36,121</td>
<td align="right">64,535</td>
<td align="right">213,437</td>
</tr>
</tbody>
</table>
<p class="caption">
<strong>Table 2</strong>: After searchResultPage De-duplication, Counts of sessions anonymously tracked and events collected during the second A/B test (Oct 27 - Nov 15).
</p>
<p>There are 22.1K visitPage events (When the user clicks a link in the results a visitPage event is created). See Table 3 for counts broken down by wiki and test group.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Summarize on a page-by-page basis for each visitPage:</span>
clickedResults &lt;-<span class="st"> </span>events %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span> =<span class="st"> </span>test_group, session_id, search_id, page_id) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(<span class="st">&quot;visitPage&quot;</span> %in%<span class="st"> </span>action) %&gt;%<span class="st"> </span><span class="co">#only checkin and visitPage action</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">ts =</span> ts[<span class="dv">1</span>], 
            <span class="dt">dwell_time=</span><span class="kw">ifelse</span>(<span class="st">&quot;checkin&quot;</span>%in%<span class="st"> </span>action, <span class="kw">max</span>(checkin, <span class="dt">na.rm=</span>T), <span class="dv">0</span>),
            <span class="dt">scroll=</span><span class="kw">sum</span>(scroll)&gt;<span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(ts)
clickedResults$dwell_time[<span class="kw">is.na</span>(clickedResults$dwell_time)] &lt;-<span class="st"> </span><span class="dv">0</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">clickedResults_summary &lt;-<span class="st"> </span>clickedResults %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> `</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="st">`</span><span class="dt">Visited pages</span><span class="st">`</span> =<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(page_id))) %&gt;%<span class="st"> </span>ungroup %&gt;%
<span class="st">  </span>{
    <span class="kw">rbind</span>(., <span class="kw">tibble</span>(
      <span class="st">`</span><span class="dt">wiki</span><span class="st">`</span> =<span class="st"> &quot;All Wikis&quot;</span>,
      <span class="st">`</span><span class="dt">Test group</span><span class="st">`</span> =<span class="st"> &quot;Total&quot;</span>,
      <span class="st">`</span><span class="dt">Visited pages</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(.$<span class="st">`</span><span class="dt">Visited pages</span><span class="st">`</span>)
    ))
  } %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">Visited pages</span><span class="st">`</span> =<span class="st"> </span><span class="kw">prettyNum</span>(<span class="st">`</span><span class="dt">Visited pages</span><span class="st">`</span>, <span class="dt">big.mark =</span> <span class="st">&quot;,&quot;</span>))
knitr::<span class="kw">kable</span>(clickedResults_summary, <span class="dt">format =</span> <span class="st">&quot;markdown&quot;</span>, <span class="dt">align =</span> <span class="kw">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;l&quot;</span>, <span class="st">&quot;r&quot;</span>, <span class="st">&quot;r&quot;</span>))</code></pre></div>
<table style="width:100%;">
<colgroup>
<col width="11%" />
<col width="73%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">wiki</th>
<th align="left">Test group</th>
<th align="right">Visited pages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">jawiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">5,431</td>
</tr>
<tr class="even">
<td align="left">jawiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">5,954</td>
</tr>
<tr class="odd">
<td align="left">thwiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">1,554</td>
</tr>
<tr class="even">
<td align="left">thwiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">1,776</td>
</tr>
<tr class="odd">
<td align="left">zhwiki</td>
<td align="left">Control Group (tf–idf)</td>
<td align="right">3,591</td>
</tr>
<tr class="even">
<td align="left">zhwiki</td>
<td align="left">Using per-field query builder with incoming links and pageviews as QIFs</td>
<td align="right">3,807</td>
</tr>
<tr class="odd">
<td align="left">All Wikis</td>
<td align="left">Total</td>
<td align="right">22,113</td>
</tr>
</tbody>
</table>
<p class="caption">
<strong>Table 3</strong>: Counts of visited pages from search sessions anonymously tracked during the second A/B test (Oct 27 - Nov 15).
</p>
</div>
<div id="results" class="section level2">
<h2>Results</h2>
<div id="zero-results-rate" class="section level3">
<h3>Zero Results Rate</h3>
<p>In Figure 1, we see that the test group that used BM25 with incoming links and pageviews as query-independent factors had a significantly lower zero results rate (ZRR). Smaller ZRR is usually better, but looking at the <a href="#paulscore">PaulScore</a>, <a href="#engagement">engagement</a> and <a href="#first_clicked_result’s_position">First Clicked Result’s Position</a>, we doubt that it came at the cost of relevance and engagement with the results. Figure 2 shows that zhwiki had the largest ZRR difference between control and test group.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">zrr_pages &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, results) %&gt;%
<span class="st">  </span>tally %&gt;%
<span class="st">  </span><span class="kw">spread</span>(results, n) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">zero results rate</span><span class="st">`</span> =<span class="st"> </span>zero/(some +<span class="st"> </span>zero)) %&gt;%
<span class="st">  </span>ungroup
zrr_pages &lt;-<span class="st"> </span><span class="kw">cbind</span>(zrr_pages, <span class="kw">as.data.frame</span>(binom:::<span class="kw">binom.bayes</span>(zrr_pages$zero, <span class="dt">n =</span> zrr_pages$some +<span class="st"> </span>zrr_pages$zero)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">zrr_pages %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="dt">y =</span> <span class="st">`</span><span class="dt">mean</span><span class="st">`</span>, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper)) +
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">limits =</span> <span class="kw">levels</span>(events$test_group)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>()) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="ot">FALSE</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Zero Results Rate&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Proportion of searches that did not yield any results, by test group&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;With 95% credible intervals.&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.2f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> `</span><span class="dt">zero results rate</span><span class="st">`</span>),
                <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>, <span class="dt">hjust =</span> <span class="st">&quot;center&quot;</span>), <span class="dt">nudge_x =</span> <span class="fl">0.1</span>) </code></pre></div>
<div class="figure">
<img src="index_files/figure-html/zrr_eda-1.png" alt="Figure 1: Zero results rate is the proportion of searches in which the user received zero results. Broken down by test group." />
<p class="caption"><strong>Figure 1</strong>: Zero results rate is the proportion of searches in which the user received zero results. Broken down by test group.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">zrr_pages &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, results) %&gt;%
<span class="st">  </span>tally %&gt;%
<span class="st">  </span><span class="kw">spread</span>(results, n) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">zero results rate</span><span class="st">`</span> =<span class="st"> </span>zero/(some +<span class="st"> </span>zero)) %&gt;%
<span class="st">  </span>ungroup
zrr_pages &lt;-<span class="st"> </span><span class="kw">cbind</span>(zrr_pages, <span class="kw">as.data.frame</span>(binom:::<span class="kw">binom.bayes</span>(zrr_pages$zero, <span class="dt">n =</span> zrr_pages$some +<span class="st"> </span>zrr_pages$zero)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]))
zrr_pages %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> mean, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(), <span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Zero Results Rate&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Proportion of searches that did not yield any results, by test group and wiki&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;With 95% credible intervals.&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.2f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> `</span><span class="dt">zero results rate</span><span class="st">`</span>),
                <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki, <span class="dt">ncol =</span> <span class="dv">3</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/zrr_eda2-1.png" alt="Figure 2: Zero results rate is the proportion of searches in which the user received zero results. Broken down by test group and wiki." />
<p class="caption"><strong>Figure 2</strong>: Zero results rate is the proportion of searches in which the user received zero results. Broken down by test group and wiki.</p>
</div>
</div>
<div id="paulscore" class="section level3">
<h3>PaulScore</h3>
<p>In Figure 3, we see that the test group had slightly lower PaulScores, which indicates that the results were less relevant. The difference is not significant when F = 0.9. This make sense because the smaller the value of scoring factor, the more weight put on the first few results, with lower ranking results counting for almost nothing. F=0.9 takes into account the broadest range of result rankings, and thus is less likely to change as dramatically. Figure 4 shows that zhwiki had the largest PaulScore differences between control and test group.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">777</span>)
paulscores &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span>ungroup %&gt;%
<span class="st">  </span><span class="kw">filter</span>(clickthrough==<span class="ot">TRUE</span>) %&gt;%<span class="st"> </span><span class="co">#???</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score (F=0.1)</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score (F=0.5)</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score (F=0.9)</span><span class="st">`</span>)) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(<span class="st">`</span><span class="dt">F value</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score</span><span class="st">`</span>, -<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">F value</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;^Query score </span><span class="ch">\\</span><span class="st">(F=(0</span><span class="ch">\\</span><span class="st">.[159])</span><span class="ch">\\</span><span class="st">)$&quot;</span>, <span class="st">&quot;F = </span><span class="ch">\\</span><span class="st">1&quot;</span>, <span class="st">`</span><span class="dt">F value</span><span class="st">`</span>)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="st">`</span><span class="dt">F value</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(
    <span class="dt">PaulScore =</span> <span class="kw">mean</span>(<span class="st">`</span><span class="dt">Query score</span><span class="st">`</span>),
    <span class="dt">Interval =</span> <span class="kw">paste0</span>(<span class="kw">quantile</span>(<span class="kw">bootstrap_mean</span>(<span class="st">`</span><span class="dt">Query score</span><span class="st">`</span>, <span class="dv">1000</span>), <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)), <span class="dt">collapse =</span> <span class="st">&quot;,&quot;</span>)
  ) %&gt;%
<span class="st">  </span><span class="kw">extract</span>(Interval, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;Lower&quot;</span>, <span class="st">&quot;Upper&quot;</span>), <span class="dt">regex =</span> <span class="st">&quot;(.*),(.*)&quot;</span>, <span class="dt">convert =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">paulscores %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">F value</span><span class="st">`</span>, <span class="dt">y =</span> PaulScore, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> Lower, <span class="dt">ymax =</span> Upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.7</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="co">#scale_y_continuous(limits = c(0.2, 0.35)) +</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;PaulScore(F)&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;PaulScore(F) by test group and value of F&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;With bootstrapped 95% confidence intervals.&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, PaulScore), <span class="dt">y =</span> Upper +<span class="st"> </span><span class="fl">0.01</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.7</span>)) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) </code></pre></div>
<div class="figure">
<img src="index_files/figure-html/paulscores_eda-1.png" alt="Figure 3: Average per-group PaulScore for various values of F (0.1, 0.5, and 0.9) with bootstrapped confidence intervals." />
<p class="caption"><strong>Figure 3</strong>: Average per-group PaulScore for various values of F (0.1, 0.5, and 0.9) with bootstrapped confidence intervals.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">777</span>)
paulscores &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span>ungroup %&gt;%
<span class="st">  </span><span class="kw">filter</span>(clickthrough==<span class="ot">TRUE</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">c</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score (F=0.1)</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score (F=0.5)</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score (F=0.9)</span><span class="st">`</span>)) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(<span class="st">`</span><span class="dt">F value</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Query score</span><span class="st">`</span>, -<span class="kw">c</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, wiki)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">F value</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sub</span>(<span class="st">&quot;^Query score </span><span class="ch">\\</span><span class="st">(F=(0</span><span class="ch">\\</span><span class="st">.[159])</span><span class="ch">\\</span><span class="st">)$&quot;</span>, <span class="st">&quot;F = </span><span class="ch">\\</span><span class="st">1&quot;</span>, <span class="st">`</span><span class="dt">F value</span><span class="st">`</span>)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="st">`</span><span class="dt">F value</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(
    <span class="dt">PaulScore =</span> <span class="kw">mean</span>(<span class="st">`</span><span class="dt">Query score</span><span class="st">`</span>),
    <span class="dt">Interval =</span> <span class="kw">paste0</span>(<span class="kw">quantile</span>(<span class="kw">bootstrap_mean</span>(<span class="st">`</span><span class="dt">Query score</span><span class="st">`</span>, <span class="dv">1000</span>), <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)), <span class="dt">collapse =</span> <span class="st">&quot;,&quot;</span>)
  ) %&gt;%
<span class="st">  </span><span class="kw">extract</span>(Interval, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;Lower&quot;</span>, <span class="st">&quot;Upper&quot;</span>), <span class="dt">regex =</span> <span class="st">&quot;(.*),(.*)&quot;</span>, <span class="dt">convert =</span> <span class="ot">TRUE</span>)
paulscores %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">F value</span><span class="st">`</span>, <span class="dt">y =</span> PaulScore, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> Lower, <span class="dt">ymax =</span> Upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.7</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="co">#scale_y_continuous(limits = c(0.2, 0.35)) +</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;PaulScore(F)&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;PaulScore(F) by wiki, test group and value of F&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;With bootstrapped 95% confidence intervals.&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.3f&quot;</span>, PaulScore), <span class="dt">y =</span> Upper +<span class="st"> </span><span class="fl">0.01</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="fl">0.7</span>)) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki, <span class="dt">ncol =</span> <span class="dv">3</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) </code></pre></div>
<div class="figure">
<img src="index_files/figure-html/paulscores_eda2-1.png" alt="Figure 4: Average per-group PaulScore for various values of F (0.1, 0.5, and 0.9) with bootstrapped confidence intervals. Broken down by test group and wiki." />
<p class="caption"><strong>Figure 4</strong>: Average per-group PaulScore for various values of F (0.1, 0.5, and 0.9) with bootstrapped confidence intervals. Broken down by test group and wiki.</p>
</div>
</div>
<div id="engagement" class="section level3">
<h3>Engagement</h3>
<p>In Figure 5, we see that the test group had a significantly lower clickthrough rate, which means users are less engaged with their search results. Again, zhwiki shows the largest discrepancy between control and test group in Figure 6.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">engagement_overall &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span><span class="kw">filter</span>(results==<span class="st">&quot;some&quot;</span>) %&gt;%<span class="st"> </span><span class="co">#???</span>
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">clickthroughs =</span> <span class="kw">sum</span>(clickthrough &gt;<span class="st"> </span><span class="dv">0</span>),
            <span class="dt">searches =</span> <span class="kw">n</span>(), <span class="dt">ctr =</span> clickthroughs/searches) %&gt;%
<span class="st">  </span>ungroup
engagement_overall &lt;-<span class="st"> </span><span class="kw">cbind</span>(
  engagement_overall,
  <span class="kw">as.data.frame</span>(
    binom:::<span class="kw">binom.bayes</span>(
      engagement_overall$clickthroughs,
      <span class="dt">n =</span> engagement_overall$searches)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]
  )
)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">engagement_overall %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> mean, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(), <span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Clickthrough rate&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Engagement with search results by test group&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>ctr), <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/engagement_overall_eda-1.png" alt="Figure 5: Clickthrough rates of test groups." />
<p class="caption"><strong>Figure 5</strong>: Clickthrough rates of test groups.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">engagement_overall &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span><span class="kw">filter</span>(results==<span class="st">&quot;some&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">clickthroughs =</span> <span class="kw">sum</span>(clickthrough &gt;<span class="st"> </span><span class="dv">0</span>),
            <span class="dt">searches =</span> <span class="kw">n</span>(), <span class="dt">ctr =</span> clickthroughs/searches) %&gt;%
<span class="st">  </span>ungroup
engagement_overall &lt;-<span class="st"> </span><span class="kw">cbind</span>(
  engagement_overall,
  <span class="kw">as.data.frame</span>(
    binom:::<span class="kw">binom.bayes</span>(
      engagement_overall$clickthroughs,
      <span class="dt">n =</span> engagement_overall$searches)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]
  )
)
engagement_overall %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> mean, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(), <span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Clickthrough rate&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Engagement with search results by test group and wiki&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>ctr), <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki, <span class="dt">ncol =</span> <span class="dv">3</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/engagement_overall_eda2-1.png" alt="Figure 6: Clickthrough rates broken down by test group and wiki." />
<p class="caption"><strong>Figure 6</strong>: Clickthrough rates broken down by test group and wiki.</p>
</div>
</div>
<div id="first-clicked-results-position" class="section level3">
<h3>First Clicked Result’s Position</h3>
<p>In Figure 7, we see that test group users were less likely to click on the first search result first than the control group. Figure 8 shows that only zhwiki users first clicked on the first result at a significantly lower rate, which indicates that the results were less relevant.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">safe_ordinals &lt;-<span class="st"> </span>function(x) {
  <span class="kw">return</span>(<span class="kw">vapply</span>(x, toOrdinal::toOrdinal, <span class="st">&quot;&quot;</span>))
}
first_clicked &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span><span class="kw">filter</span>(results ==<span class="st"> &quot;some&quot;</span> &amp;<span class="st"> </span>clickthrough &amp;<span class="st"> </span>!<span class="kw">is.na</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span> =<span class="st"> </span><span class="kw">ifelse</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span> &lt;<span class="st"> </span><span class="dv">4</span>, <span class="kw">safe_ordinals</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span> +<span class="st"> </span><span class="dv">1</span>), <span class="st">&quot;5th or higher&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span>) %&gt;%
<span class="st">  </span>tally %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total =</span> <span class="kw">sum</span>(n), <span class="dt">prop =</span> n/total) %&gt;%
<span class="st">  </span>ungroup
<span class="kw">set.seed</span>(<span class="dv">0</span>)
temp &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(binom:::<span class="kw">binom.bayes</span>(first_clicked$n, <span class="dt">n =</span> first_clicked$total, <span class="dt">tol =</span> .Machine$double.eps^<span class="fl">0.1</span>)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)])
first_clicked &lt;-<span class="st"> </span><span class="kw">cbind</span>(first_clicked, temp); <span class="kw">rm</span>(temp)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">first_clicked %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> mean, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>prop), <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(),
                     <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.005</span>), <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> `</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span>, <span class="dt">scale =</span> <span class="st">&quot;free_y&quot;</span>, <span class="dt">nrow =</span> <span class="dv">1</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Proportion of searches&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Position of the first clicked result&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;With 95% credible intervals&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,
        <span class="dt">panel.grid.major.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.grid.minor.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;gray90&quot;</span>),
        <span class="dt">panel.border =</span> <span class="kw">element_rect</span>(<span class="dt">color =</span> <span class="st">&quot;gray30&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>))</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/first_clicked_position_eda-1.png" alt="Figure 7: First clicked result’s position by test group." />
<p class="caption"><strong>Figure 7</strong>: First clicked result’s position by test group.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">first_clicked &lt;-<span class="st"> </span>searches %&gt;%
<span class="st">  </span><span class="kw">filter</span>(results ==<span class="st"> &quot;some&quot;</span> &amp;<span class="st"> </span>clickthrough &amp;<span class="st"> </span>!<span class="kw">is.na</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span>)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span> =<span class="st"> </span><span class="kw">ifelse</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span> &lt;<span class="st"> </span><span class="dv">4</span>, <span class="kw">safe_ordinals</span>(<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span> +<span class="st"> </span><span class="dv">1</span>), <span class="st">&quot;5th or higher&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span>) %&gt;%
<span class="st">  </span>tally %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total =</span> <span class="kw">sum</span>(n), <span class="dt">prop =</span> n/total) %&gt;%
<span class="st">  </span>ungroup
<span class="kw">set.seed</span>(<span class="dv">0</span>)
temp &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(binom:::<span class="kw">binom.bayes</span>(first_clicked$n, <span class="dt">n =</span> first_clicked$total, <span class="dt">tol =</span> .Machine$double.eps^<span class="fl">0.1</span>)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)])
first_clicked &lt;-<span class="st"> </span><span class="kw">cbind</span>(first_clicked, temp); <span class="kw">rm</span>(temp)
first_clicked %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> mean, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>prop), <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(),
                     <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.005</span>), <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki+<span class="st">`</span><span class="dt">first clicked result&#39;s position</span><span class="st">`</span>, <span class="dt">scale =</span> <span class="st">&quot;free_y&quot;</span>, <span class="dt">ncol=</span><span class="dv">5</span>, <span class="dt">nrow =</span> <span class="dv">3</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Proportion of searches&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Position of the first clicked result&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;With 95% credible intervals&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,
        <span class="dt">panel.grid.major.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.grid.minor.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),
        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;gray90&quot;</span>),
        <span class="dt">panel.border =</span> <span class="kw">element_rect</span>(<span class="dt">color =</span> <span class="st">&quot;gray30&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>))</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/first_clicked_position_eda2-1.png" alt="Figure 8: First clicked result’s position by test group and wiki." />
<p class="caption"><strong>Figure 8</strong>: First clicked result’s position by test group and wiki.</p>
</div>
</div>
<div id="dwell-time-per-visited-page" class="section level3">
<h3>Dwell Time per Visited Page</h3>
<p>Figures 9 and 10 show the survival curve for each test group and wiki. Except zhwiki, users are more likely to stay longer on visited pages, which implies the results in test group are more relevant for jawiki and thwiki.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">clickedResults %&gt;%
<span class="st">  </span><span class="kw">split</span>(.$<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">map_df</span>(function(df) {
    seconds &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">210</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>, <span class="dv">420</span>)
    seshs &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">do.call</span>(cbind, <span class="kw">lapply</span>(seconds, function(second) {
      <span class="kw">return</span>(<span class="kw">sum</span>(df$dwell_time &gt;=<span class="st"> </span>second))
    })))
    <span class="kw">names</span>(seshs) &lt;-<span class="st"> </span>seconds
    <span class="kw">return</span>(<span class="kw">cbind</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span> =<span class="st"> </span><span class="kw">head</span>(df$<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="dv">1</span>), <span class="dt">n =</span> seshs$<span class="st">`</span><span class="dt">0</span><span class="st">`</span>, seshs, <span class="st">`</span><span class="dt">450</span><span class="st">`</span>=seshs$<span class="st">`</span><span class="dt">420</span><span class="st">`</span>))
  }) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(seconds, visits, -<span class="kw">c</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, n)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">seconds =</span> <span class="kw">as.numeric</span>(seconds)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, seconds) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> visits/n) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">group=</span><span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="dt">color=</span><span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_step</span>(<span class="kw">aes</span>(<span class="dt">x =</span> seconds, <span class="dt">y =</span> proportion), <span class="dt">direction =</span> <span class="st">&quot;hv&quot;</span>) +
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;T (Dwell Time in seconds)&quot;</span>, <span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">210</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>, <span class="dv">420</span>))+<span class="st"> </span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Proportion of visits longer than T (P%)&quot;</span>, <span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(),
                     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/dwell_time_eda-1.png" alt="Figure 9: At time T, at most P% of users still stay on their visited pages. Broken down by test group." />
<p class="caption"><strong>Figure 9</strong>: At time T, at most P% of users still stay on their visited pages. Broken down by test group.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">clickedResults %&gt;%
<span class="st">  </span><span class="kw">split</span>(<span class="kw">list</span>(.$wiki, .$<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">map_df</span>(function(df) {
    seconds &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">210</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>, <span class="dv">420</span>)
    seshs &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">do.call</span>(cbind, <span class="kw">lapply</span>(seconds, function(second) {
      <span class="kw">return</span>(<span class="kw">sum</span>(df$dwell_time &gt;=<span class="st"> </span>second))
    })))
    <span class="kw">names</span>(seshs) &lt;-<span class="st"> </span>seconds
    <span class="kw">return</span>(<span class="kw">cbind</span>(<span class="dt">wiki=</span><span class="kw">head</span>(df$wiki, <span class="dv">1</span>), <span class="st">`</span><span class="dt">test group</span><span class="st">`</span> =<span class="st"> </span><span class="kw">head</span>(df$<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="dv">1</span>), <span class="dt">n =</span> seshs$<span class="st">`</span><span class="dt">0</span><span class="st">`</span>, seshs, <span class="st">`</span><span class="dt">450</span><span class="st">`</span>=seshs$<span class="st">`</span><span class="dt">420</span><span class="st">`</span>))
  }) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(seconds, visits, -<span class="kw">c</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, n)) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">seconds =</span> <span class="kw">as.numeric</span>(seconds)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, seconds) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> visits/n) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">group=</span><span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="dt">color=</span><span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_step</span>(<span class="kw">aes</span>(<span class="dt">x =</span> seconds, <span class="dt">y =</span> proportion), <span class="dt">direction =</span> <span class="st">&quot;hv&quot;</span>) +
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;T (Dwell Time in seconds)&quot;</span>, <span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">210</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>, <span class="dv">420</span>))+<span class="st"> </span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Proportion of visits longer than T (P%)&quot;</span>, <span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(),
                     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki, <span class="dt">ncol=</span><span class="dv">1</span>, <span class="dt">nrow =</span><span class="dv">3</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/dwell_time_eda_wiki-1.png" alt="Figure 10: At time T, at most P% of users still stay on their visited pages. Broken down by test group and wiki." />
<p class="caption"><strong>Figure 10</strong>: At time T, at most P% of users still stay on their visited pages. Broken down by test group and wiki.</p>
</div>
</div>
<div id="scroll" class="section level3">
<h3>Scroll</h3>
<p>In Figures 11 and 12, we can see that users in the test group are more likely to scroll on the visited pages, but the differences are not statistically significant.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scroll_overall &lt;-<span class="st"> </span>clickedResults %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">scrolls=</span><span class="kw">sum</span>(scroll), <span class="dt">visits=</span><span class="kw">n</span>(), <span class="dt">proportion =</span> <span class="kw">sum</span>(scroll)/<span class="kw">n</span>()) %&gt;%
<span class="st">  </span>ungroup
scroll_overall &lt;-<span class="st"> </span><span class="kw">cbind</span>(
  scroll_overall,
  <span class="kw">as.data.frame</span>(
    binom:::<span class="kw">binom.bayes</span>(
      scroll_overall$scrolls,
      <span class="dt">n =</span> scroll_overall$visits)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]
  )
)
scroll_overall %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> mean, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(), <span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Proportion of visits&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Proportion of visits with scroll by test group&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>proportion), <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/scroll_eda-1.png" alt="Figure 11: Proportion of visited pages with scroll by test group." />
<p class="caption"><strong>Figure 11</strong>: Proportion of visited pages with scroll by test group.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scroll_overall &lt;-<span class="st"> </span>clickedResults %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">scrolls=</span><span class="kw">sum</span>(scroll), <span class="dt">visits=</span><span class="kw">n</span>(), <span class="dt">proportion =</span> <span class="kw">sum</span>(scroll)/<span class="kw">n</span>()) %&gt;%
<span class="st">  </span>ungroup
scroll_overall &lt;-<span class="st"> </span><span class="kw">cbind</span>(
  scroll_overall,
  <span class="kw">as.data.frame</span>(
    binom:::<span class="kw">binom.bayes</span>(
      scroll_overall$scrolls,
      <span class="dt">n =</span> scroll_overall$visits)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]
  )
)
scroll_overall %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> mean, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(), <span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Proportion of visits&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Proportion of visits with scroll by test group and wiki&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>proportion), <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki, <span class="dt">ncol =</span> <span class="dv">3</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/scroll_eda_wiki-1.png" alt="Figure 12: Proportion of visited pages with scroll by test group and wiki." />
<p class="caption"><strong>Figure 12</strong>: Proportion of visited pages with scroll by test group and wiki.</p>
</div>
</div>
<div id="query-reformulation" class="section level3">
<h3>Query Reformulation</h3>
<p>First, we tokenized queries from zhwiki, jawiki and thwiki with <a href="https://github.com/fxsjy/jieba">jieba</a>, <a href="https://pypi.python.org/pypi/tinysegmenter">tinysegmenter</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-termvectors.html">elasticsearch termvectors api</a> separately. Then we filter out <a href="https://github.com/6/stopwords-json">stop words</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># See tokenize.R for more details</span>
<span class="kw">library</span>(jiebaR)
<span class="kw">library</span>(ropencc)

<span class="co">#thwiki</span>
<span class="kw">load</span>(<span class="st">&quot;../data/tokens_th.RData&quot;</span>)
tokens_th &lt;-<span class="st"> </span>output; <span class="kw">rm</span>(output)
stopword_th &lt;-<span class="st"> </span>jsonlite::<span class="kw">fromJSON</span>(<span class="st">&quot;../resource/th.json&quot;</span>)
tokens_th &lt;-<span class="st"> </span><span class="kw">filter_segment</span>(tokens_th,stopword_th)

<span class="co">#zhwiki</span>
queries_zh &lt;-<span class="st"> </span>searches[searches$wiki==<span class="st">&quot;zhwiki&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;page_id&quot;</span>,<span class="st">&quot;query&quot;</span>)]
queries_zh$query &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;[[:punct:]]&quot;</span>, <span class="st">&quot; &quot;</span>, queries_zh$query)
stopword_zh &lt;-<span class="st"> </span>jsonlite::<span class="kw">fromJSON</span>(<span class="st">&quot;../resource/zh.json&quot;</span>)
ccst =<span class="st"> </span><span class="kw">converter</span>(S2T)
stopword_zh &lt;-<span class="st"> </span><span class="kw">union</span>(ccst[stopword_zh], stopword_zh)
mixseg =<span class="st"> </span><span class="kw">worker</span>(<span class="dt">bylines =</span> <span class="ot">TRUE</span>)
tokens_zh &lt;-<span class="st"> </span>mixseg[queries_zh$query]
tokens_zh &lt;-<span class="st"> </span><span class="kw">filter_segment</span>(tokens_zh,stopword_zh)
<span class="kw">names</span>(tokens_zh) &lt;-<span class="st"> </span>queries_zh$page_id

<span class="co">#jawiki</span>
tokens_ja &lt;-<span class="st"> </span>jsonlite::<span class="kw">fromJSON</span>(<span class="st">&quot;../data/tokens_ja.json&quot;</span>)
stopword_ja &lt;-<span class="st"> </span>jsonlite::<span class="kw">fromJSON</span>(<span class="st">&quot;../resource/ja.json&quot;</span>)
tokens_ja &lt;-<span class="st"> </span><span class="kw">filter_segment</span>(tokens_ja,stopword_ja)
tokens_ja &lt;-<span class="st"> </span><span class="kw">lapply</span>(tokens_ja, function(x) <span class="kw">gsub</span>(<span class="st">&quot; +&quot;</span>,<span class="st">&quot;&quot;</span>,x)) <span class="co"># strip space before/after string</span></code></pre></div>
<p>We consider two queries as a reformulation if 1) they are from the same search session and share at least one result, or 2) they are from the same search session and share at least one word.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(igraph)
all_tokens &lt;-<span class="st"> </span><span class="kw">c</span>(tokens_ja, tokens_zh, tokens_th)

overlapping_results &lt;-<span class="st"> </span>function(x) {
  if (<span class="kw">all</span>(<span class="kw">is.na</span>(x))) {
    <span class="kw">return</span>(<span class="kw">diag</span>(<span class="kw">length</span>(x)))
  }
  input &lt;-<span class="st"> </span><span class="kw">strsplit</span>(stringr::<span class="kw">str_replace_all</span>(x, <span class="st">&quot;[</span><span class="ch">\\</span><span class="st">[</span><span class="ch">\\</span><span class="st">]]&quot;</span>, <span class="st">&quot;&quot;</span>), <span class="st">&quot;,&quot;</span>)
  output &lt;-<span class="st"> </span><span class="kw">vapply</span>(input, function(y) {
    temp &lt;-<span class="st"> </span><span class="kw">vapply</span>(input, function(z) { <span class="kw">length</span>(<span class="kw">intersect</span>(z, y)) }, 0L)
    temp[<span class="kw">is.na</span>(x)] &lt;-<span class="st"> </span>0L
    <span class="kw">return</span>(temp)
  }, <span class="kw">rep</span>(0L, <span class="kw">length</span>(input)))
  <span class="kw">diag</span>(output) &lt;-<span class="st"> </span>1L
  <span class="kw">return</span>(output)
}

reformulation &lt;-<span class="st"> </span>function(result_pids, page_ids, all_tokens) {
  if(<span class="kw">length</span>(page_ids)==<span class="dv">1</span>){
    <span class="kw">return</span>(<span class="kw">data.frame</span>(<span class="dt">n_search=</span><span class="dv">1</span>, <span class="dt">n_reformulate=</span><span class="st">&quot;0&quot;</span>))
  }
  <span class="co"># result overlap</span>
  overlaps_res &lt;-<span class="st"> </span><span class="kw">overlapping_results</span>(result_pids)
  <span class="co"># tokens overlap</span>
  this_tokens &lt;-<span class="st"> </span>all_tokens[page_ids]
  overlaps_token &lt;-<span class="st"> </span><span class="kw">vapply</span>(this_tokens, function(y) {
    temp &lt;-<span class="st"> </span><span class="kw">vapply</span>(this_tokens, function(z) { <span class="kw">length</span>(<span class="kw">intersect</span>(z, y)) }, 0L)
    temp[<span class="kw">is.na</span>(this_tokens)] &lt;-<span class="st"> </span>0L
    <span class="kw">return</span>(temp)
  }, <span class="kw">rep</span>(0L, <span class="kw">length</span>(this_tokens)))
  <span class="kw">diag</span>(overlaps_token) &lt;-<span class="st"> </span>1L
  
  overlaps_all &lt;-<span class="st"> </span>(overlaps_res +<span class="st"> </span>overlaps_token) &gt;<span class="st"> </span><span class="dv">0</span>
  <span class="kw">diag</span>(overlaps_all) &lt;-<span class="st"> </span>0L
  graph_object &lt;-<span class="st"> </span><span class="kw">graph_from_adjacency_matrix</span>(overlaps_all, <span class="dt">mode =</span> <span class="kw">c</span>(<span class="st">&quot;undirected&quot;</span>), <span class="dt">diag =</span> F)
  csize &lt;-<span class="st"> </span><span class="kw">clusters</span>(graph_object)$csize
  <span class="kw">return</span>(<span class="kw">data.frame</span>(<span class="dt">n_search=</span><span class="kw">length</span>(csize), <span class="dt">n_reformulate=</span><span class="kw">ifelse</span>(<span class="kw">length</span>(csize)&gt;<span class="dv">1</span>,<span class="kw">paste</span>(csize<span class="dv">-1</span>, <span class="dt">collapse=</span><span class="st">&#39;,&#39;</span> ), <span class="kw">as.character</span>(csize<span class="dv">-1</span>))))
}

reform_times &lt;-<span class="st"> </span>searches %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, session_id, search_id) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">do</span>(<span class="kw">reformulation</span>(.$<span class="st">`</span><span class="dt">result page IDs</span><span class="st">`</span>, .$page_id, all_tokens))</code></pre></div>
<p>We grouped connected searches together using the rules above, then we have 51354 total search groups.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reform_times %&gt;%<span class="st"> </span>ungroup %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">n_search=</span><span class="kw">ifelse</span>(n_search&gt;=<span class="dv">10</span>,<span class="st">&quot;10+&quot;</span>,n_search)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(n_search) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n_session=</span><span class="kw">n</span>()) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop=</span>n_session/<span class="kw">sum</span>(n_session)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n_search, <span class="dt">y =</span> prop)) +
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;Proportion of search sessions&quot;</span>, <span class="dt">labels =</span> scales::<span class="kw">percent_format</span>()) +
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="st">&quot;Number of Search Groups&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">1</span>:<span class="dv">9</span>, <span class="st">&quot;10+&quot;</span>)) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span>*prop)), <span class="dt">nudge_y =</span> <span class="fl">0.025</span>) +
<span class="st">  </span>ggthemes::<span class="kw">theme_tufte</span>(<span class="dt">base_family =</span> <span class="st">&quot;Gill Sans&quot;</span>, <span class="dt">base_size =</span> <span class="dv">14</span>) +
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Proportion of search sessions making N search groups&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/reform_n_search_group-1.png" alt="Figure 13: Proportion of search sessions making N search groups. A search group is a group of searches from the same search session, in which one search is connected with at least another one if they share at least one common word or at least one common result." />
<p class="caption"><strong>Figure 13</strong>: Proportion of search sessions making N search groups. A search group is a group of searches from the same search session, in which one search is connected with at least another one if they share at least one common word or at least one common result.</p>
</div>
<p>In Figure 14 and Figure 16, we can see that test group users are less likely to reformulate their queries. Figure 15 and Figure 17 show that zhwiki had the largest discrepancy between control and test group.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reformulation_counts &lt;-<span class="st"> </span>reform_times %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="st">`</span><span class="dt">searches with query reformulations</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(<span class="kw">as.numeric</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(n_reformulate, function(x) <span class="kw">strsplit</span>(x, <span class="st">&quot;,&quot;</span>)))) &gt;<span class="st"> </span><span class="dv">0</span>),
            <span class="dt">searches =</span> <span class="kw">sum</span>(n_search),
            <span class="dt">proportion =</span> <span class="st">`</span><span class="dt">searches with query reformulations</span><span class="st">`</span>/searches) %&gt;%
<span class="st">  </span>ungroup
reformulation_counts &lt;-<span class="st"> </span><span class="kw">cbind</span>(
  reformulation_counts,
  <span class="kw">as.data.frame</span>(
    binom:::<span class="kw">binom.bayes</span>(
      reformulation_counts$<span class="st">`</span><span class="dt">searches with query reformulations</span><span class="st">`</span>,
      <span class="dt">n =</span> reformulation_counts$searches,
      <span class="dt">tol =</span> .Machine$double.eps^<span class="fl">0.1</span>)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]
  )
)
reformulation_counts %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>, <span class="dt">y =</span> <span class="st">`</span><span class="dt">mean</span><span class="st">`</span>, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper)) +
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">limits =</span> <span class="kw">levels</span>(events$test_group)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>()) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="ot">FALSE</span>) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;% of searches with query reformulations&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Searches with reformulated queries by test group&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;Queries were grouped when they shared common results or common key words&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.2f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>proportion),
                <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>, <span class="dt">hjust =</span> <span class="st">&quot;center&quot;</span>), <span class="dt">nudge_x =</span> <span class="fl">0.1</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/reform_eda1-1.png" alt="Figure 14: Proportions of searches where user reformulated their query." />
<p class="caption"><strong>Figure 14</strong>: Proportions of searches where user reformulated their query.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reformulation_counts &lt;-<span class="st"> </span>reform_times %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="st">`</span><span class="dt">searches with query reformulations</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(<span class="kw">as.numeric</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(n_reformulate, function(x) <span class="kw">strsplit</span>(x, <span class="st">&quot;,&quot;</span>)))) &gt;<span class="st"> </span><span class="dv">0</span>),
            <span class="dt">searches =</span> <span class="kw">sum</span>(n_search),
            <span class="dt">proportion =</span> <span class="st">`</span><span class="dt">searches with query reformulations</span><span class="st">`</span>/searches) %&gt;%
<span class="st">  </span>ungroup
reformulation_counts &lt;-<span class="st"> </span><span class="kw">cbind</span>(
  reformulation_counts,
  <span class="kw">as.data.frame</span>(
    binom:::<span class="kw">binom.bayes</span>(
      reformulation_counts$<span class="st">`</span><span class="dt">searches with query reformulations</span><span class="st">`</span>,
      <span class="dt">n =</span> reformulation_counts$searches)[, <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)]
  )
)
reformulation_counts %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="st">`</span><span class="dt">mean</span><span class="st">`</span>, <span class="dt">color =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>(), <span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;% of searches with query reformulations&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Searches with reformulated queries by test group and wiki&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;Queries were grouped when they shared common results or common key words&quot;</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>proportion), <span class="dt">y =</span> upper +<span class="st"> </span><span class="fl">0.0025</span>, <span class="dt">vjust =</span> <span class="st">&quot;bottom&quot;</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)+
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki, <span class="dt">ncol =</span> <span class="dv">3</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/reform_eda1_wiki-1.png" alt="Figure 15: Proportions of searches where user reformulated their query. Broken down by wiki." />
<p class="caption"><strong>Figure 15</strong>: Proportions of searches where user reformulated their query. Broken down by wiki.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">count_reformulation &lt;-<span class="st"> </span>function(n_reformulate){
  temp &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(n_reformulate, function(x) <span class="kw">strsplit</span>(x, <span class="st">&quot;,&quot;</span>))))
  temp &lt;-<span class="st"> </span><span class="kw">ifelse</span>(temp&gt;=<span class="dv">3</span>, <span class="st">&quot;3+&quot;</span>, temp)
  output &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">table</span>(temp))
  output$proportion &lt;-<span class="st"> </span>output$Freq/<span class="kw">sum</span>(output$Freq)
  <span class="kw">colnames</span>(output)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;query reformulations&quot;</span>
  <span class="kw">return</span>(output)
}
reform_times %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">do</span>(<span class="kw">count_reformulation</span>(.$n_reformulate)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">query reformulations</span><span class="st">`</span>, <span class="dt">y =</span> proportion, <span class="dt">fill =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>()) +
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>proportion), <span class="dt">vjust =</span> -<span class="fl">0.5</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Proportion of searches&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Approximate number of query reformulations per grouped search&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Number of query reformulations by test group&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;Queries were grouped when they shared common results or common key words&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/reform_eda2-1.png" alt="Figure 16: Proportions of searches with 0, 1, 2, and 3+ query reformulations." />
<p class="caption"><strong>Figure 16</strong>: Proportions of searches with 0, 1, 2, and 3+ query reformulations.</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reform_times %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(wiki, <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw">do</span>(<span class="kw">count_reformulation</span>(.$n_reformulate)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">query reformulations</span><span class="st">`</span>, <span class="dt">y =</span> proportion, <span class="dt">fill =</span> <span class="st">`</span><span class="dt">test group</span><span class="st">`</span>)) +
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>) +
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::<span class="kw">percent_format</span>()) +
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="st">&quot;Test Group&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">guide =</span> <span class="kw">guide_legend</span>(<span class="dt">ncol =</span> <span class="dv">2</span>)) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="dv">100</span> *<span class="st"> </span>proportion), <span class="dt">vjust =</span> -<span class="fl">0.5</span>),
            <span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="dt">width =</span> <span class="dv">1</span>)) +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Proportion of searches&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Approximate number of query reformulations per grouped search&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Number of query reformulations by test group and wiki&quot;</span>,
       <span class="dt">subtitle =</span> <span class="st">&quot;Queries were grouped when they shared common results or common key words&quot;</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)+
<span class="st">  </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>wiki, <span class="dt">ncol =</span> <span class="dv">3</span>)</code></pre></div>
<div class="figure">
<img src="index_files/figure-html/reform_eda2_wiki-1.png" alt="Figure 17: Proportions of searches with 0, 1, 2, and 3+ query reformulations. Broken down by wiki." />
<p class="caption"><strong>Figure 17</strong>: Proportions of searches with 0, 1, 2, and 3+ query reformulations. Broken down by wiki.</p>
</div>
</div>
</div>
<div id="conclusion-and-discussion" class="section level2">
<h2>Conclusion and Discussion</h2>
<p>For the test group, we observed a much better ZRR but slightly worse PaulScores, large decrease in clickthrough rate, and fewer users clicked on the first result first, indicating that we are showing users worse results. However, dwell-time and query reformulation analysis show that users may like the results they are getting in some aspect. We recommend deploying BM25 for all wikis but not reindexing projects in space-less languages for now.</p>
<p>This test revealed the performance of BM25 is unsatisfactory on space-less languages: some CirrusSearch components are dependent on the presence of spaces. We agree that the current behavior (forcing a proximity match on every query) is far from ideal but given the outcome of the test we decided not to move forward without prior work on space-less languages. We need better tokenization, and we need to track and fix all the components that make the bold assumption of the presence of spaces to activate/deactivate features.</p>
<p>The relatively large decrease in engagement and relevancy for zhwiki may be the result of tokenizer behavior. Chinese is the sole language in this test where we do not have a custom analysis chain. We emit only unigrams, so any page that randomly has all the same characters as the query in it will be returned. This can greatly decreases ZRR without any increase in search result quality or relevance. In English this would be roughly similar to returning any page that had all the same letters as the query.</p>
<p>The query reformulation analysis in this report is not ideal. Firstly, finding out shared tokens could not detect reformulated queries when users fix a typo in space-less languages. For example, when users modify their queries from “灯龙” to “灯笼” (lantern) they are fixing a typo, but tokenizers would take them as two different words. Secondly, we found that many users like to try their queries in different languages. Without enabling search across wikis in different languages, we are unable to detect this kind of reformulation.</p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://tools-static.wmflabs.org/cdnjs/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
